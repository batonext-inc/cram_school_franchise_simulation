# コーディング規約
- コメントは日本語で。
- serenaのメモリから、現状を抜き出し把握すること
- プラン作成時に詳細なタスク分けを行うこと
- タスクが終わるたびにserenaに進捗状況を更新、gitにコミット＆プッシュを行うこと

# 📄 **要件定義書**

**「塾のフランチャイズオーナーになろう！」**
*(HTML + CSS + JavaScript + Canvas 2D)*

---

# 1. ゲーム概要

プレイヤーは **学習塾のフランチャイズオーナー（フランチャイジー）** となり、初期資金 **1000万円** を元手に、
  Math.round(baseNewStudents * clamp(1 + satisfaction / 100, 0.3, 1.7));

例（満足度 +40 → 1.4倍、満足度 -20 → 0.8倍）

* 世界観設定として、**プレイヤーはすでにフランチャイズ契約済み**。
  ただし案内役「エージェント」が塾名を“ど忘れ”した体裁で、プレイヤーに塾名を再設定させる。
* 校舎は **複数開校可能**。
* 各校舎の経営は独立して管理され、**全校舎合計の生徒数**が最終スコアの基準になる。
* 各校舎には複数の **クラス（classroom）** があり、
  **1クラスにつき：先生1人 / 生徒最大80人** が所属。
* 生徒は年度ごとに動き、**満足度** に応じて次年度の新規入塾数が変動する。
* 校舎ごとに「広告宣伝」を行える。効果は **駅乗降客数** に依存。
* フランチャイズ本部へ毎月 **ロイヤリティ（1校舎あたり20万円）** を支払う。
* 最終目的：
  **X6年3月終了時点での「総生徒数」を最大化すること**
  （ランク評価あり）

---

# 2. プレイヤー設定（エージェントとの会話形式）

ゲーム開始後、案内人「エージェント」と会話しながら以下を決定する：

### 2.1 プレイヤー名

* テキスト入力

### 2.2 塾名（接頭辞 + 接尾辞プルダウン）

* プレイヤーが入力するのは「接頭辞」のみ
* 接尾辞は以下からプルダウンで選択：

  * 塾
  * 教室
  * アカデミー
  * ゼミナール
  * 予備校

最終的な塾名：

```
schoolName = prefixInput + selectedSuffix
```

### 2.3 会話の体裁（フランチャイズ情報ど忘れ）

例（抜粋）：

> 「ありがとうございます、〇〇さん。
> あの……実はお恥ずかしいのですが、〇〇さんが加盟される塾の名前を、私ど忘れしてしまいまして……」
>
> 「あなたが加盟する予定の塾の名前って、なんでしたっけ？」
>
> 「差し支えなければ、もう一度教えていただけませんか？」

ユーザーが塾名を入力したあと：

> 「なるほど！『◯◯◯◯△△』ですね。本部にもこの名前で登録しておきます！」

### 2.4 初校舎の選択

* 会話の終盤で、**最初に開校する校舎** を 8 校舎（八王子／千葉／大宮／川崎／中野／秋葉原／新宿／東京）から 1 つ選択する。
* 選択肢には「商圏内生徒数」と「駅乗降客数」を併記し、立地比較をしやすくする。
* 確定した校舎がゲーム開始時点の初期拠点となり、以降は未選択の校舎を「新規開校」で追加する。
* UI は各校舎のサムネイル画像（`assets/img/school/<campusId>.png`）と商圏／駅データ／初期投資費用を表示するカード型レイアウトで、クリックしたカードが選択状態になる。
* 初期投資費用が初期資金（1,000万円）を上回る校舎は「資金不足」バッジ付きで表示され、選択不可。

### 2.5 保存データ

```json
{
  "playerName": "山田太郎",
  "schoolName": "山田進学ゼミナール"
}
```

### 2.6 タイトル画面導線

* 「新しく始める」ボタンで会話フェーズを最初から開始。
* 「続きから始める」ボタンで 3 つのセーブスロット（A / B / C）一覧を開き、任意のスロットからロードして即座に経営フェーズへ遷移。
* セーブデータが存在しない場合は「続きから始める」ボタンを無効化し、ホバー時やラベルで未保存であることを示す。
* スロット一覧では塾名・プレイヤー名・保存時点（年月・保存日時）・資金/校舎数などの概要を表示し、ロード不可スロットには「ロード不可」チップを表示する。

---

# 3. 校舎（キャンパス）と立地

## 3.1 校舎リスト

ゲームに登場する校舎は以下の8つ。
（ゲーム開始時は会話で選んだ1校舎を即開校し、残りは「新規開校」で追加）

* 八王子校
* 千葉校
* 大宮校
* 川崎校
* 中野校
* 秋葉原校
* 新宿校
* 東京校

---

## 3.2 校舎データ項目（完全修正版）

今回の仕様変更により、

* **世帯平均年収（廃止）**
* **周辺学校の数（廃止）**

その代わりに **商圏内生徒数（旧：10代以下人口）** を主要パラメータ化。

---

### 校舎データ表（最新）

| 校舎名 | 商圏内生徒数（人） | 家賃相場（万円/月） | 駅乗降客数（万人/日） | 初期投資費用（万円） | 受入上限（人） | 授業料（月額） |
| --- | ---: | ---: | ---: | ---: | ---: | ---: |
| 八王子校 | 3,000 | 40.0 | 8 | 390 | 360 | 27,900円 |
| 千葉校 | 3,500 | 35.5 | 10 | 426 | 360 | 27,000円 |
| 大宮校 | 5,000 | 38.0 | 25 | 456 | 480 | 27,500円 |
| 川崎校 | 6,000 | 44.0 | 19 | 560 | 540 | 28,600円 |
| 中野校 | 7,000 | 48.0 | 24 | 630 | 600 | 30,800円 |
| 秋葉原校 | 8,000 | 65.5 | 22 | 780 | 720 | 32,700円 |
| 新宿校 | 10,000 | 82.0 | 67 | 1,200 | 840 | 33,000円 |
| 東京校 | 12,000 | 105.0 | 43 | 1,600 | 960 | 35,000円 |

* 初期投資費用は家賃水準に比例し、各校舎ごとに390万〜1,600万円の範囲で設定される。新規開校時に資金から即座に差し引かれる。

---

## 3.3 校舎データのゲーム内での役割

### ● 商圏内生徒数（人）

* 地域の潜在的な生徒数
* **初期生徒数の計算**に使用
* **年度末の新規入塾数**のベースにも使用

### ● 家賃相場（万円）

* 校舎ごとの **固定費（家賃）** に影響

例：

```js
rentCost = 家賃相場 * 10000; // 円
```

### ● 駅乗降客数（万人）

* **広告宣伝の効果倍率** を決めるパラメータ

```js
adFactor = 1.0 + (station_traffic * adCoefficient);
```

新宿校（67万人）は圧倒的に広告効率が高い。

### ● 初期投資費用（万円）

* 新規開校の際に必要な一時費用。
* 開校実行時にプレイヤー資金から減算される。
* 家賃相場に比例（最低390万円、最大1,600万円）。

### ● 受入上限（人）

* 校舎ごとに想定される最大生徒数。
* `intakeCapacity` を超えると先生・クラス追加イベントが発生しやすくなる。

### ● 授業料（円）

* `tuitionPerStudent` として月次売上計算に利用。
* 立地難易度に応じて微妙に差を付け、ハイグレード校ほど単価が高い。

---

# 4. 先生（Teacher）とクラス（Classroom）

## 4.1 Teacher クラス（プログラム仕様）

```js
class Teacher {
  constructor({ id, templateId, name, rank, baseSalary, satisfactionImpact, gender, specialty }) {
    this.id = id;
    this.templateId = templateId; // 先生アイコンやテンプレ特性を特定するキー
    this.name = name;
    this.rank = rank; // 'senior' | 'mid' | 'junior'
    this.baseSalary = baseSalary; // 月給（円）
    this.satisfactionImpact = satisfactionImpact; // 満足度への影響
    this.gender = gender;
    this.specialty = specialty;
  }
}
```

### ランクごとの特徴（例）

| ランク  | 月給      | 満足度インパクト   |
| ---- | ------- | ---------- |
| ベテラン | 40〜60万円 | +3〜+5      |
| 中堅   | 25〜35万円 | +1〜+3      |
| 新米   | 15〜25万円 | -1〜+1（不安定） |

* 先生アイコンは `assets/img/people/teacher/t-{j|m|s}-{f|m}{1|2}.png` という命名規則（rank/性別/バリエーション）で管理する。

---

## 4.2 Classroom クラス

```js
class Classroom {
  constructor({ id, campusId, teacherId, capacity = 60, studentCount = 0 }) {
    this.id = id;
    this.campusId = campusId;
    this.teacherId = teacherId;
    this.capacity = capacity; // 常に80
    this.studentCount = studentCount;
  }
}
```

---

## 4.3 クラス数と生徒数の関係（重要）

先生1人が年間で担当できるのは **最大80人**。ただし実際の授業編成は1クラス **最大20人** のユニットで表示・管理する。

例：新宿校の生徒数が75人の場合、実務上は先生1人でカバーできる（75人 ≤ 80人）が、UI上のクラス表示や席数計算は `Math.ceil(75 / 20) = 4` クラスとする。

校舎の生徒数に応じて必要クラス数を決める：

```js
requiredClasses = Math.ceil(studentCount / 20);
```

必要先生数は `Math.ceil(studentCount / 80)` を基準にする。クラス表示はあくまで編成イメージとして20人区切りで増減させる。

### ● 強制追加採用のルール

生徒数が

* **81人以上** → クラス2つ必要 → 先生2人必要
* **161人以上** → クラス3つ必要 → 先生3人必要
* …以降も同様

不足がある場合：

> 「先生が不足しています。追加の先生を採用してください。」

という専用画面が開き、採用するまで「次の月へ」へ進めない。

## 4.4 初期配置ルール

* 会話で選んだ **初校舎** では、選択直後にエージェントが
  「◯◯校で開校準備を進めています。商圏規模に応じて初月からまとまった生徒が集まりそうです。」
  「まずは1人目の先生を採用しましょう。」
  と伝え、学校カードと同じレイアウトの **先生選択画面**（先生のアイコン＋ステータスカード）に遷移する。
* ここでプレイヤーが 1 人目の先生を決定し、その先生のクラスに `Math.round(marketStudents / 200)` 人の初期生徒が割り当てられる（必要なら追加クラスが自動生成される）。
* 以降に開校する校舎も同じロジック（`initialStudents = Math.round(marketStudents / 200)`）で生徒数が決まり、必要なクラス／先生数が自動で充足される。

---

# 5. 生徒の満足度

## 5.1 満足度の概要

* 各校舎は **-100〜+100** の満足度スコアを持ち、**0 がニュートラル**（どちらでもない）
* プラスは満足・マイナスは不満を表し、絶対値が大きいほど影響が強い
* 初期値は 0（ニュートラル）で、月次シミュレーションによって変動する
* 毎月以下で変動：

  * 先生の質：ベテラン多 → 上昇
  * クラス過密：容量超過 → 減少
  * ランダム揺らぎ（±2程度）
  * 生徒純増：ネットで増えれば上昇、減れば低下

---

## 5.2 満足度更新ロジック例

```js
function updateSatisfaction(current, teachers, classrooms) {
  const teacherBonus = teachers.reduce((sum, t) => sum + t.satisfactionImpact, 0);

  const totalStudents = classrooms.reduce((sum, c) => sum + c.studentCount, 0);
  const totalCapacity = classrooms.length * 60;
  const loadFactor = totalStudents / Math.max(1, totalCapacity);

  let loadPenalty = 0;
  if (loadFactor > 1) {
    loadPenalty = -5 * (loadFactor - 1);
  }

  const randomShake = (Math.random() * 2 - 1) * 2;

  let next = current + teacherBonus + loadPenalty + randomShake;
  return Math.max(-100, Math.min(100, next));
}
```

---

## 5.3 次年度入塾生徒数への影響

年度末（毎年3月）：

```js
newStudentsNextYear =
  Math.round(baseNewStudents * clamp(1 + satisfaction / 100, 0.3, 1.7));
```

例（満足度 +40 → 1.4倍、満足度 -20 → 0.8倍）

新規生徒はクラスに再分配し、
必要ならクラス増設 → 先生追加が必要。

  ※ `clamp(value, min, max)` は値を指定範囲に収める補助関数。

## 5.4 月次の生徒増減

年度更新を待たず、毎月以下のロジックで生徒数を増減させる：

```js
const baseInflow = Math.round(marketStudents * monthlyInflowCoeff);
const satisfactionFactor = clamp(1 + satisfaction / 100, 0.3, 1.7);
const stationTrafficCoefficient = 0.005;
const stationBoost = 1 + stationTraffic * stationTrafficCoefficient;
const adBoost = 1 + activeAdPlan.effect * stationBoost;
const inflow = Math.round(baseInflow * satisfactionFactor * adBoost);
const attrition = Math.round(currentStudents * monthlyAttritionRatio);
const randomShake = Math.round((Math.random() * 2 - 1) * monthlyRandomShake);
nextStudents = currentStudents - attrition + inflow + randomShake;
```

* 満足度が高いほど月次流入が増加。
* 満足度がマイナスの場合は `satisfactionFactor` が 1 未満となり、流入が抑制される。
* 広告プランは設定した翌月から `effect` を流入計算に加算する。
* ランダム揺らぎで ±数名のばらつきを与え、単調な推移を避ける。

---

# 6. 売上・コスト・ロイヤリティ・広告宣伝

## 6.1 初期生徒数

- すべての校舎は開校時に `Math.round(marketStudents / 200)` 人の生徒を獲得し、必要なクラス＋先生を揃えて運営を開始する（1 クラス最大80人）。
- 商圏内生徒数が多い立地を選ぶほど初期生徒数も増え、初期投資が高い校舎を選ぶ動機付けになる。

---

## 6.2 授業料（収益性）

**世帯平均年収パラメータは廃止**されたため、授業料は以下いずれかを採用：

* **全校舎一律の授業料**
* または校舎難易度による微差（任意）

（詳細は後で調整可能）

---

## 6.3 月次売上

```js
revenue = totalStudentCount * tuitionPerStudent;
```

---

## 6.4 月次コスト（完全版）

```js
rentCost      = rent_index * 10000;
salaryCost    = sum(teachers.baseSalary);
royaltyCost   = 200000; // フランチャイズ基本料：毎月20万円
adCost        = selectedAdPlan.cost;
otherCost     = ...
totalCost     = rentCost + salaryCost + adCost + royaltyCost + otherCost;
```

---

## 6.5 広告宣伝（校舎単位）

各校舎ごとに以下の広告プランから 1 つを選択する。選択したプランは**翌月から**費用と効果が反映され、月次の生徒流入計算に倍率を与える。いつでも「広告なし」に戻せる。

| プラン名 | 月額費用 | 基本効果 (`effect`) | 備考 |
| --- | --- | --- | --- |
| 広告なし | 0円 | 0.00 | 費用・効果ともに発生しない |
| チラシ配り | 5万円 | 0.05 | 校舎周辺での配布。手軽だが効果控えめ |
| 新聞広告 | 20万円 | 0.12 | 地域紙・折込で幅広い層へ訴求 |
| 中吊り広告 | 50万円 | 0.20 | 高額だが即効性が高い広域訴求 |

月次の流入補正は以下で求める：

```js
adBoost = 1 + effect * (1 + stationTraffic * stationTrafficCoefficient);
```

* `stationTrafficCoefficient` は 0.005（= 0.5%）で固定。駅乗降客数が多い校舎ほど広告効果が伸びる。
* プラン変更は UI のモーダルで行い、設定した次の月から `adBoost` が反映される。

---

```markdown
# 📄 **完全版 要件定義書（Part 2 / 2）**
**「塾のフランチャイズオーナーになろう！」**
*(HTML + CSS + JavaScript + Canvas 2D)*

---

# 7. ゲーム内の時間と月次進行

## 7.1 時間の概念（重要）

ゲーム内の時間は以下のように進行する：

- **開始：X1年4月**
- **終了：X6年3月**
- 合計：**60ヶ月（5年間）**

1ターン = 1ヶ月
ターンの進行形式：

```

X1年4月 → X1年5月 → … → X1年12月 → X2年1月 → … → X6年3月

````

## 7.2 年度の区切り

- 「4月〜翌年3月」を **1年度** とする
- 年度末の「3月」に以下の処理が行われる：

### ● 年度末処理

* 生徒数の増減は月次ロジックで完了しているため、年度末では主に以下を行う：
  1. 年度サマリー（収支・満足度・ランキング）の集計表示（将来拡張）。
  2. 翌年度ラベルへの繰り上げ、および各種フラグのリセット。
* 先生不足イベントやクラス整備は、月次処理内で常にチェックする。

---

# 8. メイン画面（経営フェーズ）

## 8.1 メイン画面の構成

- 校舎リスト
- 校舎別の情報（タブ形式）
  - 生徒数
  - クラス数
  - 先生一覧
  - 満足度
  - 売上
  - 家賃・給与・広告費・ロイヤリティコスト
- 全校舎の合計資金
- 月次グラフ（Canvas 折れ線、収支推移 etc.）
- 画面右上のヘッダーには「現在の年月」と「資金残高」を常時表示し、その直下に「生徒数」「満足度」のミニメトリクスを並べて即時確認できるようにする

---

## 8.2 メイン画面の **常設メニュー**

プレイヤーは毎月「次の月へ」ボタンを押す前に、必ず以下のメニューへアクセス可能。

---

### **① 新規開校**

- 未開校の校舎から 1 校舎を追加できる
- 開校には「初期投資費用」が必要（例：50万〜200万円）
- 新規校舎には次が必須：
  - 先生採用
  - クラス構築（最低1クラス）
  - 初期生徒の割り当て

複数校舎を持つと、UI は校舎切り替えタブ形式に自動切り替え。

---

### **② 広告宣伝（校舎ごとのプラン選択）**

- 「広告プラン設定」ボタンでモーダルを開き、`広告なし / チラシ配り / 新聞広告 / 中吊り広告` のいずれかを選ぶ。
- 選択したプランは翌月から自動で更新され、月次の生徒流入と広告費に反映される。
- UI では「現在のプラン」と「来月以降に適用予定のプラン」を併記し、切り替え忘れを防ぐ。

---

### **③ セーブ（手動保存）**

* localStorage にゲーム進行データを保存
* 3つのセーブスロット（A / B / C）を表示し、任意のスロットへ保存可能。
* 既存データがあるスロットを選ぶ場合は上書き確認ダイアログを表示。
* セーブ完了後はタイトル画面の「続きから始める」ボタンを有効化し、スロット一覧のメタ情報（塾名・年月・資金など）を更新する。

---

### **④ ロード（手動読込）**

* localStorage の 3 スロット一覧から読み込むデータを選択し、完全復元。
* セーブデータがないスロットを選んだ場合はロード不可メッセージを表示。
* タイトル画面の「続きから始める」ボタン、およびメイン画面の「ロード」ボタンは同じスロットモーダルを開く。

---

### **⑤ 次の月へ**

1ヶ月分のシミュレーション処理：

1. 売上計算
2. 家賃・給与・広告費・ロイヤリティなどのコスト計算
3. 満足度の変動
4. 資金更新
5. 年度末（3月）の場合は年度切り替え処理
6. 先生不足チェック（必要なら採用画面へ遷移）

---

# 9. セーブ／ロード仕様（詳細）

## 9.1 セーブ

保存対象：

* セーブ時に選択したスロット（A / B / C）単位で localStorage に保存（UI 側は常に 3 スロット固定表示）。
* 保存日時 `savedAt`（ISO文字列）を記録し、スロットカードで「YYYY/MM/DD HH:MM」形式に表示。
* プレイヤー名、塾名
* 現在の年月（Xn年m月）
* 資金
* 校舎情報（複数）

  * 校舎ID
  * 生徒数
  * 満足度
  * 広告設定（現在のプランID / 次月適用予定のプランID）
  * 先生構成
  * クラス情報（全クラス）
* 売上履歴
* 先生一覧の内部 ID

### セーブデータ（例）

```json
{
  "playerName": "山田太郎",
  "schoolName": "山田進学アカデミー",
  "year": 3,
  "month": 7,
  "money": 12500000,
  "campuses": [
    {
      "id": "shinjuku",
      "studentCount": 120,
      "satisfaction": 75,
          "adPlanId": "poster",
          "nextAdPlanId": null,
      "teachers": [
        { "id": "t1", "rank": "senior" },
        { "id": "t2", "rank": "mid" }
      ],
      "classrooms": [
        { "id": "c1", "teacherId": "t1", "studentCount": 20 },
        { "id": "c2", "teacherId": "t2", "studentCount": 20 },
        { "id": "c3", "teacherId": "t3", "studentCount": 20 }
      ]
    }
  ]
}
```

---

## 9.2 ロード

* データなし → エラー表示
* データあり → 全ゲーム状態を復元

---

# 10. 拡張候補（任意）

（すべてゲーム完成後に追加可能なモジュール）

1. **広告レベル制**
2. **先生のランクアップ機能**
3. **校舎の専門分野化（大学受験特化 etc.）**
4. **季節イベント（夏期講習、冬期講習）**
5. **合格実績によるブランド強化**
6. **校舎設備投資・リフォーム機能**

---

# 11. データ構造（JSON / JSクラスの仕様まとめ）

## 校舎データ（固定値）

```json
[
  {
    "id": "shinjuku",
    "name": "新宿校",
    "marketStudents": 10000,
    "rent": 13.4,
    "stationTraffic": 67
  }
]
```

## Teacher クラス

```js
class Teacher {
  constructor({ id, name, rank, baseSalary, satisfactionImpact }) {}
}
```

## Classroom クラス

```js
class Classroom {
  constructor({ id, campusId, teacherId, capacity, studentCount }) {}
}
```

---

# 12. 推奨フォルダ構成

```
project-root/
│ index.html
│ style.css
│ main.js
│
├── data/
│   ├── campuses.json
│   └── initialTeachers.json
│
├── js/
│   ├── player.js
│   ├── campus.js
│   ├── teacher.js
│   ├── classroom.js
│   ├── simulation.js
│   ├── ui.js
│   ├── saveLoad.js
│   ├── canvasGraph.js
│   └── canvasMap.js
│
└── assets/
    └── icons/
```

---

# 13. 開発・動作確認環境

- ローカル確認は **VS Code + Live Server 拡張** を基本とし、`index.html` を Live Server で開いて `http://localhost:5500` 付近のポートで動作確認する。
- 追加の検証が必要な場合のみ、`npx serve` など任意の静的サーバーを利用してもよい。
- Python の `http.server` など他手段での定常チェックは不要。Live Server があれば十分とする。

---
